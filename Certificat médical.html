<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ü©∫ G√©n√©rateur de Certificat M√©dical</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <body class="bg-light">
  <div class="container py-5">
    <div class="card shadow-lg">
      <div class="card-body">
        <h2 class="card-title text-center mb-4">ü©∫ Formulaire de Certificat M√©dical</h2>
        <form id="patientForm">

          <div class="d-flex justify-content-between mb-4">
            <a href="Accueil.html" class="btn btn-outline-secondary">‚Ü©Ô∏è Retour √† l'accueil</a>
            <button type="button" class="btn btn-outline-danger" onclick="reinitialiserForm()">‚ùå R√©initialiser</button>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="nom" class="form-label">Nom du Patient</label>
              <input type="text" class="form-control" id="nom" required>
            </div>
            <div class="col-md-6">
              <label for="prenom" class="form-label">Pr√©nom du Patient</label>
              <input type="text" class="form-control" id="prenom" required>
            </div>
            <div class="col-md-6">
              <label for="dateNaissance" class="form-label">Date de naissance</label>
              <input type="date" class="form-control" id="dateNaissance" required>
            </div>
            <div class="col-md-6">
              <label for="sexe" class="form-label">Sexe</label>
              <select class="form-select" id="sexe">
                <option value="M">M</option>
                <option value="Mme">Mme</option>
                <option value="L‚Äôenfant">L'enfant</option>
              </select>
            </div>
          </div>

          <hr class="my-4">

          <fieldset class="mb-4">
            <legend class="h5 mb-3">‚úÖ Mentions √† inclure dans le certificat</legend>

            <div class="form-check mb-3">
              <input type="checkbox" class="form-check-input" id="condition1" onchange="toggleInput('input1')">
              <label class="form-check-label" for="condition1">Le patient est apte √† entrer en classe de</label>
              <input type="text" id="input1" class="form-control mt-2" style="display:none;" placeholder="ex: CE2">
            </div>

            <div class="form-check mb-3">
              <input type="checkbox" class="form-check-input" id="condition2" onchange="toggleInput('input2')">
              <label class="form-check-label" for="condition2">Le patient ne pr√©sente aucune contre-indication √† la pratique du</label>
              <input type="text" id="input2" class="form-control mt-2" style="display:none;" placeholder="ex: football">
            </div>

            <div class="form-check mb-3">
              <input type="checkbox" class="form-check-input" id="condition3" onchange="toggleInput('input3')">
              <label class="form-check-label" for="condition3">Dispense de sport pour une dur√©e de</label>
              <input type="text" id="input3" class="form-control mt-2" style="display:none;" placeholder="ex: 7">
            </div>

            <div class="form-check mb-3">
              <input type="checkbox" class="form-check-input" id="condition4" onchange="toggleInput('input4')">
              <label class="form-check-label" for="condition4">Absence de l'√©cole / lyc√©e / travail pour une dur√©e de</label>
              <input type="text" id="input4" class="form-control mt-2" style="display:none;" placeholder="ex: 5">
            </div>
          </fieldset>

          <div class="d-grid">
            <button type="button" class="btn btn-primary btn-lg" onclick="generatePDF()">üìù G√©n√©rer le certificat m√©dical</button>
          </div>

        </form>
      </div>
    </div>
  </div>
</body>

  <script>
    let medecinNom = "";
    let medecinSpecialite = "";	
    let medecinLieu = "";

    function toggleInput(inputId) {
      const input = document.getElementById(inputId);
      if (input) {
        input.style.display = input.style.display === 'none' ? 'block' : 'none';
        if(input.style.display === 'none') {
          input.value = "";
        }
      }
    }

    async function generatePDF() {
      await chargerMedecin();

      const { jsPDF } = window.jspdf;

      const nom = document.getElementById('nom').value.trim();
      const prenom = document.getElementById('prenom').value.trim();

      const rawDate = document.getElementById('dateNaissance').value; // yyyy-mm-dd
      const dateParts = rawDate.split('-'); // ["aaaa", "mm", "jj"]
      const dateNaissance = dateParts.length === 3 ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` : rawDate;

      const sexe = document.getElementById('sexe').value;

      if (!nom || !prenom || !rawDate) {
        alert("Veuillez remplir tous les champs obligatoires.");
        return;
      }

      const doc = new jsPDF();

      // En-t√™te color√©
      doc.setFillColor(52, 152, 219);
      doc.rect(0, 0, 210, 20, 'F');
      doc.setFontSize(20);
      doc.setTextColor(255, 255, 255);
      doc.text("Certificat M√©dical", 105, 14, { align: "center" });
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(14);

      doc.text(`${medecinNom},`, 20, 30);
      doc.text(medecinSpecialite, 20, 38);
      const currentDate = new Date().toLocaleDateString("fr-FR");
      doc.text(`Le ${currentDate},`, 150, 30);
      doc.text(`√Ä ${medecinLieu}`, 150, 38);

      doc.setFontSize(12);
      doc.text(`Je soussign√©, ${medecinNom}, certifie sur l'honneur avoir auscult√© ce jour ${sexe} ${prenom} ${nom},`, 20, 60);
      doc.text(`n√©(e) le ${dateNaissance}, et je certifie que :`, 20, 70);

      const conditions = [
        { id: 'condition1', inputId: 'input1', label: "Le patient est apte √† entrer en classe de" },
        { id: 'condition2', inputId: 'input2', label: "Le patient ne pr√©sente aucune contre-indication √† la pratique du" },
        { id: 'condition3', inputId: 'input3', label: "L'√©tat de sant√© du patient n√©cessite une dispense de sport pour une dur√©e de" },
        { id: 'condition4', inputId: 'input4', label: "L'√©tat de sant√© du patient n√©cessite une absence de l'√©cole / lyc√©e / travail pour une dur√©e de" },
      ];

      let y = 90;
      conditions.forEach((cond, index) => {
        if (document.getElementById(cond.id).checked) {
          let valeur = document.getElementById(cond.inputId)?.value.trim() || "____";

          // Ajout automatique de "jour(s)" pour les conditions 3 et 4
          if (index === 2 || index === 3) {
            valeur += " jour(s)";
          }

          const ligne = `- ${cond.label} ${valeur}`;
          const splitText = doc.splitTextToSize(ligne, 170);
          doc.text(splitText, 20, y);
          y += splitText.length * 10;
        }
      });

      const today = new Date();
      const dateStr = today.toLocaleDateString("fr-FR");
      doc.text(`Certificat remis en main propre √† la demande de l'int√©ress√©(e) le ${dateStr}.`, 20, y + 20);

      doc.save(`certificat medical - ${prenom} ${nom}_.pdf`);
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
    storageBucket: "urgences-a8ed4.appspot.com",  
    messagingSenderId: "392921498200",
    appId: "1:392921498200:web:7ccce767332c67c697c02d",
    measurementId: "G-C74MK2KYDL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function chargerMedecin() {
      try {
        const docRef = db.collection("medecins").doc("6ReBiDXM3pOXl5cK7AkJ8C0NtFf2");
        const docSnap = await docRef.get();
        if (docSnap.exists) {
          const data = docSnap.data();
          medecinNom = data.nom || medecinNom;
          medecinSpecialite = data.specialite || medecinSpecialite;
          medecinLieu = data.lieu || medecinLieu;
        }
      } catch (error) {
        console.error("Erreur chargement m√©decin :", error);
      }
    }

    async function chargerDepuisFirestore(id) {
      try {
        const docRef = db.collection("patients").doc(id);
        const docSnap = await docRef.get();
        if (docSnap.exists) {
          const data = docSnap.data();
          document.getElementById('nom').value = data.nom || "";
          document.getElementById('prenom').value = data.prenom || "";

          if (data.dateNaissance) {
            const date = data.dateNaissance.toDate ? data.dateNaissance.toDate() : new Date(data.dateNaissance);
            document.getElementById('dateNaissance').value = date.toISOString().split("T")[0];
          }
          const sexe = data.sexe || data.Sexe || "M";
          document.getElementById('sexe').value = sexe;
        }
      } catch (e) {
        console.error("Erreur Firestore :", e);
      }
    }

    window.onload = function() {
      const id = new URLSearchParams(window.location.search).get('id');
      if (id) {
        chargerDepuisFirestore(id);
      } else {
        const data = localStorage.getItem("certificatPatient");
        if (data) {
          const patient = JSON.parse(data);
          document.getElementById('nom').value = patient.nom || "";
          document.getElementById('prenom').value = patient.prenom || "";
          document.getElementById('dateNaissance').value = patient.dateNaissance || "";
          document.getElementById('sexe').value = patient.sexe || "M";
          localStorage.removeItem("certificatPatient");
        }
      }
    };

    function reinitialiserForm() {
      document.getElementById('nom').value = "";
      document.getElementById('prenom').value = "";
      document.getElementById('dateNaissance').value = "";
      document.getElementById('sexe').value = "";
      ['condition1', 'condition2', 'condition3', 'condition4'].forEach((id, index) => {
        const checkbox = document.getElementById(id);
        const input = document.getElementById('input' + (index + 1));
        if (checkbox) checkbox.checked = false;
        if (input) {
          input.value = "";
          input.style.display = 'none';
        }
      });
    }

  </script>
</body>
</html>
